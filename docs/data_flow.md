## Task state lifecycle

- __waiting__ - initial state for all added tasks. Needed to prepare
  complex dependencies like chains.
  - to __idle__
  - to __startable__
- __idle__ - for active "operators", while wait for children to complete.
  Those tasks are not processed by workers directly, but executed on
  children state change.
  - to __finished__
- __startable__ - tasks to run when worker is ready to consume
  - to __locked__
- __locked__ - tasks, executed by workers right now
  - to __restart__
  - to __finished__
- __restart__ waiting for restart
  - to __startable__
- __finished__

To guaranty data consistency and decouple logic, task data updates can be
combined with emit of additional command. See below.


## Redis content

All keys starts with namespace prefix defined in constructor, "idoit:"
by default.

- __idoit:waiting__                 (set)
- __idoit:idle__                    (set)
- __idoit:\<pool>:startable__        (set)
- __idoit:locked__                  (zset)
- __idoit:restart__                 (zset)
- __idoit:finished__                (zset)
- __idoit:\<taskID\>__              (hash) - serialized tasks data
- __idoit:\<pool>:commands__         (zset) - internal transactions queue
- __idoit:\<pool>:commands_locked__  (zset)


## Commands

Commands are internal actions to decouple complex logic. For example when
child task finishes we should update parent state (change progress, switch to
next child it chain and so on). It would be very difficult to do everything
in one step in consistent way. We split all to small changes and care that
each one is eventually consistent.

- Each command can be executed in only one worker at the same time.
- Different commands can be executed in parallel and in any order (even if
  there are multiple commands for the same task)
- All critical commands properly resolve races, out of order run and rerun
  or crash.
- Task progress CAN glitch on edge cases (node/redis/network outage), but that's
  considered to be not critical and acceptable. This info is for interface
  update ONLY and should not be used in other way.

Note, since task `id` can be NOT unique for singletone tasks, we use `uid`
info to verify source/destination. So, if you stop and run task again,
commands from previous batch will be ignored.

Available commands:

- __activate__ - used to move task from _waiting_ to _startable_ or _idle_
- __progress__ - used to increment parent progress
- __result__ - used to notify parent when child finished
- __error__ - used to notify parent when child errored
- __iterate__ - used to invoke iterator step
- __group_check__ - used to move group to finished if all children done

Fields:

- __to__ (String)       - task which should receive command
- __to_uid__ (Number)   - all except `activate`, task uid
- __type__ (String)     - command type
- __data__ (String)     - command data
- __rnd__ (String)      - random string to guarantee unique value for
                          serialized command


## Task data

Task data is serializeable object. It contains info about:

- task class & properties (how to unserialize instance + defaults/options)
- task params (payload)
- current state, if needed (progress, metadata and other)

Fields:

- __name__               - task type
- __id__                 - task ID (random by default)
- __uid__                - autogenerated unique random ID
- __pool__               - pool ID (53 bits, generated from poolName)
- __retries__            - number of retry on error
- __progress__           - current task progress
- __total__              - optional, max progress value (usually for groups,
                           chains and iterators).
- __state__              - current task state
- __args__               - the task args
- __parent__             - optional, parent task ID
- __parent_uid__         - optional, parent `uid` value, if `parent` field exists
- __parent_pool__        - optional, parent `pool` value, if `parent` field exists
- __result__             - optional, task result
- __error__              - optional, task error
- __children__           - optional
  - for chain and group - array of all child task IDs
  - for iterator - array of active child task IDs (i.e. created, but not yet finished)
- __children_finished__  - optional, number of finished children
- __children_created__   - optional, number of created children (iterator only)
- __user_data__          - optional, persistent data between iterator calls
